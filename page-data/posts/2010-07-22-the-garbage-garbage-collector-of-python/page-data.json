{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/posts/2010-07-22-the-garbage-garbage-collector-of-python","webpackCompilationHash":"c8ed51f8e74f03200d92","result":{"data":{"site":{"siteMetadata":{"title":"Excursion in Distraction","author":"@dsvensson"}},"markdownRemark":{"html":"<p>Two years ago we started our journey to write what would become an enterprise server software in the Python language. Over time we’ve done some pretty nutty things that wouldn’t have been made if the Python VM wasn’t crap. The reason we started with Python was due to a constraint on how to communicate with a core component in the environment. In hindsight we probably should have written our own library from start (we have done so today), but it was also an interesting ride.</p>\n<p>Like everyone else we noticed that Python becomes slower and slower for each thread you add, specially on SMP systems, thanks to the glorious Global Interpreter Lock. With the help of python-multiprocessing we later were able to take advantage of the 8 cores available to us, at the cost of copying a lot of data between processes (5-60 processes depending on configuration), and consuming a heap of RAM (16-24GB were not uncommon). To reduce the work of using multiprocessing, <a href=\"https://web.archive.org/web/20130427010602/http://opensource.purplescout.se/wiki/orb\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">python-orb</a> was created (which could do with a bit more polish, but it suits our needs).</p>\n<p>Later on we noticed that our software pretty much crawled to a halt at a regular interval. At last we started to realize that this might be caused by the Python garbage collector. After some investigation this turned out to be the case, and we decided to just skip the garbage collector altogether as it only helps when you have circular references in your application (Python is otherwise reference counted), and those can be fairly easily circumvented.</p>\n<p>Python being a dynamic language means that you pretty much have to make up for the rapid development and compact syntax with twice as many test cases (yes, your application will start with completely broken syntax, and typos until it’s time to execute that particular line of code). This is not really that bad as the tests too are rapidly developed, and you need to have tests to prove that your software does what you want even after a major refactoring.</p>\n<p>At the time we found the problem we simply disabled the garbage collector in our test-framework and started logging <code class=\"language-text\">gc.collect()</code>’s after each test method had run. In addition to this, we added support for running the garbage collector on demand in our software so that we could run it for some hours with tons of data and then see if a <code class=\"language-text\">gc.collect()</code> returned something. Some days later we had nailed the last of the few cyclic references and were ready to run the whole application with the garbage collector disabled. Result was a lot better performance, and the end of stop-the-world garbage collections. Win!</p>\n<p>The new version of our product relies on a much better virtual machine, namely the JVM, we do however still use Python a lot for non performance critical scripting, and for analyzing data and so on. During last week I analyzed a lot of data to locate a bug, this involved loading up a blob of JSON data and juggle it around until something interesting popped up (and it did!). This is a prime example of what disabling the garbage collector can do for you on a daily basis, so here it comes:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">import</span> cjson<span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">,</span> gc\n\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">read_json_blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>    t0 <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>    fd <span class=\"token operator\">=</span> <span class=\"token builtin\">file</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mytestfile\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>    data <span class=\"token operator\">=</span> fd<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>    fd<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>    t1 <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>    parsed <span class=\"token operator\">=</span> cjson<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>    t2 <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>    <span class=\"token keyword\">print</span> <span class=\"token string\">\"read file in %.2fs, parsed json in %.2fs, total of %.2fs\"</span> <span class=\"token operator\">%</span> \\\\\n                                                   <span class=\"token punctuation\">(</span>t1<span class=\"token operator\">-</span>t0<span class=\"token punctuation\">,</span> t2<span class=\"token operator\">-</span>t1<span class=\"token punctuation\">,</span> t2<span class=\"token operator\">-</span>t0<span class=\"token punctuation\">)</span>\n\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> read_json_blob<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># read file in 10.57s, parsed json in 531.10s, total of 541.67s</span>\n\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> gc<span class=\"token punctuation\">.</span>disable<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> read_json_blob<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># read file in 0.59s, parsed json in 15.13s, total of 15.72s</span>\n\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> gc<span class=\"token punctuation\">.</span>collect<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 0</span></code></pre></div>\n<p>Ok, so that’s 15 seconds instead of about 9 minutes until I’m able to to start to analyze the data, and of course there was nothing for the garbage collector to collect afterwards. The file in question is a 1.2GB JSON text file, the disks perform at about 110MB/s sequential reads, and we have 8 cores of Intel Xeon E5520 2.27GHz to use (only one core used in this example).</p>\n<p>I hope this saves someone elses time as it has saved mine.</p>","fields":{"slug":"posts/2010-07-22-the-garbage-garbage-collector-of-python","readingTime":{"text":"4 min read"}},"frontmatter":{"title":"The Garbage Garbage Collector of Python","date":"22 Jul '10"}},"headerImage":{"childImageSharp":{"fluid":{"tracedSVG":"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='400' height='27'%3e%3cpath d='M2 1L1 13l-1 6c0 4 0 4 3 4 2 0 2 0 1 1H1l-1 1c0 2 3 2 15 2h14v-5c0-5-1-6-3-4v3c0 1-2 2-5 2l-4 1-2 1-2-1c0-2 6-4 9-4 3 1 3-1-1-2-3 0-1-2 4-2 3 0 4-1 4-3l-1-3H16C5 10 5 10 5 3c0-3-2-4-3-2m32 13v13h9c7 0 9 0 9-2 0 0-1-2-3-2-3-1-3-1-2-8V9h-3l-4 1V5c0-5 0-5-3-5h-2l-1 14m20-2v11h4c3 0 4 0 5 2 0 2 1 2 14 2 16 0 15 1 15-11 0-8 1-12 3-12l1 10c0 6 0 9 1 8 1-2 1-2 1 0 1 1 1 2 2 1l2 1 1 2V4c0-3-1-4-6-4-6 0-6 0-5 2 0 4-8 7-20 7h-9V0h-9v12m57-5c-1 8 0 14 4 17v1l-2 1 14 1 14-1h2l10 1c11 0 11 1 11-22V0l-2 3-2 4c1 1 0 1-3 1l-7 1-5-1c-3-3-2-5 1-5l3-1h-3l-3-1-2-1-1 1c1 0-1 3-3 3l-3-2c-3-2-4-2-9-2h-11c-3 0-3 0-3 7m68-4c0 3 0 3 2 1 0-1 2-2 3-1 1 0 1 1-1 3-2 1-2 2-1 2v1l-1 3c0 1-1 2-2 1v6c0 1 1 2 5 2 7 2 8 2 2 2l-6 1h2l3 1c0 1 2 2 10 2 9 0 10 0 10-2 0-1 1-2 3-2h3V0h-33l1 3m36-2c-2 2 0 26 1 26v-1c0-2 1-2 3 0l9 1h8l-2-3-1-2c1-1-6-14-7-13-2 1-5-1-5-5-1-3-1-3-2-1l-1 3V3c0-2-2-4-3-2m99 0c-1 2 3 8 5 9v3l-1-1-2-1 1 2v2c-2 1-2 1-2-1s0-2-1-1h-2l-1 2 1 2 1-1h1l-1 2-1 3-2-3c-2-2-7-2-5 0h2l1 1-3 1c-2 0-2 0-2 2l1 3c0 2 1 2 48 2h48V15c0-10 0-11-2-11-1 0-2 0-2-2 0-3-9-3-11 0v2h-1l-1 1c-1 1-1 0-1-2 1-4-1-4-2 0 0 2-1 2-1 1V2c0-2 0-2-1-1l-2 1c1 4-1 6-4 5-4 0-6-2-3-2 2 0 2 0 1-1-2 0-2-1-1-2l2 1c0 2 1 1 3-1 1-2 0-2-3-2l-7 2c-2 1-2 2-1 2h2l-2 1-2 2 2 1c2-1 4 0 4 2l-5 1-6 1h-1l2-2 1-2-2-4V0h-9c-9 0-10 0-10 2l-1 3V2c0-2-1-2-3-2l-3 1h-2c-2-1-7-1-7 1l1 1v1c0 2-2 0-2-2s-5-3-6-1m-44 7l-1 1c-1-1-1 1-1 3 0 4 0 4-1 1 0-3-1-3-5-4l-6-1c-1 0-1 4 1 10l2 6c1 3 1 3 11 3 7 0 9 0 9-2v-3l-2-2-2-5-3-5c-1-4-2-5-2-2' fill='%23d3d3d3' fill-rule='evenodd'/%3e%3c/svg%3e","aspectRatio":14.867924528301886,"src":"/static/843c5f7defd25c41f8cae57182fd6f1f/1bdc6/wastelands-header.jpg","srcSet":"/static/843c5f7defd25c41f8cae57182fd6f1f/accda/wastelands-header.jpg 200w,\n/static/843c5f7defd25c41f8cae57182fd6f1f/fc61b/wastelands-header.jpg 400w,\n/static/843c5f7defd25c41f8cae57182fd6f1f/1bdc6/wastelands-header.jpg 800w,\n/static/843c5f7defd25c41f8cae57182fd6f1f/34bdc/wastelands-header.jpg 1200w,\n/static/843c5f7defd25c41f8cae57182fd6f1f/bdccb/wastelands-header.jpg 1600w,\n/static/843c5f7defd25c41f8cae57182fd6f1f/0ffcb/wastelands-header.jpg 3940w","sizes":"(max-width: 800px) 100vw, 800px"}}},"indexImage":null},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"posts/2010-07-22-the-garbage-garbage-collector-of-python","previous":{"fields":{"slug":"posts/2010-03-25-setting-up-redmine"},"frontmatter":{"title":"Setting up Redmine"}},"next":{"fields":{"slug":"posts/2011-02-14-software-quality-in-an-open-source-world"},"frontmatter":{"title":"Software Quality in an Open Source World"}}}}}